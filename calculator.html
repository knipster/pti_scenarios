<!doctype html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
   <link rel="stylesheet" href="calculator.css">


   <!-- Google Analytic Tracking-->
   <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VJ88QLQFCL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VJ88QLQFCL');
</script>

  </head>
    <body>
      <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
        <header class="masthead mb-auto">
          <div class="inner">
            <h3 class="masthead-brand">PTI Movement Scenarios</h3>
          </div>
        </header>


    <div class="container" id="inputs">

      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Player PTI:</span>
        </div>
        <input id="ptiPlayer" type="number" class="form-control pti" value=0 placeholder="0" aria-label="Player PTI" aria-describedby="basic-addon1">
      </div>

      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Partner PTI:</span>
        </div>
        <input  id="ptiPartner" type="number" class="form-control pti" value=0  placeholder="0" aria-label="Partner PTI" aria-describedby="basic-addon1">
      </div>

      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Opp PTI:</span>
        </div>
        <input id="ptiOpp1" type="number" class="form-control pti" value=0 placeholder="0" aria-label="First Opponent PTI" aria-describedby="basic-addon1">
      </div>

      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Opp PTI:</span>
        </div>
        <input id="ptiOpp2" type="number" class="form-control pti" value=0  placeholder="0" aria-label="Second Opponent PTI" aria-describedby="basic-addon1">
      </div>
    <br>
    </div>
    <div class="container" id="intermediate_results">
    <h5><span class="label label-default" id="lblExpected" for="expected">Expected:</span></h5>
    <h5><span class="label label-default" id="lblSpread" for="expected">Spread:</span></h5>
    <h5><span class="label label-default" id="lblSpreadScale" for="expected">Scale:</span></h5>
  </div>
  <div class="container" id="chart">
    <canvas id="chartJSContainer" width="300" height="270"></canvas>
  </div>
    <!-- Optional JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.js"></script>
    <script src="pti_match_result_scenarios.js"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script>
/**
 * Feature detect + local reference for simple use of local storage
 * Use like:
 * if (storage) {
 *    storage.setItem('key', 'value');
 *    storage.getItem('key');
 * }
 *
 */
 var storage;
var fail;
var uid;
try {
  uid = new Date;
  (storage = window.localStorage).setItem(uid, uid);
  fail = storage.getItem(uid) != uid;
  storage.removeItem(uid);
  fail && (storage = false);
} catch (exception) {}

function savePTI() {
  if(storage) {
    storage.setItem('playerPTI',$('#ptiPlayer').val());
    storage.setItem('partnerPTI',$('#ptiPartner').val());
    storage.setItem('opp1PTI',$('#ptiOpp1').val());
    storage.setItem('opp2PTI',$('#ptiOpp2').val());
  }

}

function restorePTI() {
  if(storage) {
    $('#ptiPlayer').val(parseFloat(storage.getItem('playerPTI')) || 0);
    $('#ptiPartner').val(parseFloat(storage.getItem('partnerPTI')) || 0);
    $('#ptiOpp1').val(parseFloat(storage.getItem('opp1PTI')) || 0);
    $('#ptiOpp2').val(parseFloat(storage.getItem('opp2PTI')) || 0);
  }

}
restorePTI();
$(".pti").change(updateExpected);
var expected = 0.5377;
var PTISpread = 0;
var PTISpreadScale = 1;

function pti_expected() {
  return 1 - (1 / (1 + 10 ** ((PTISpread) / 24)))
}

function pti_adjustment(expected_result,actual_result) {
  if (((expected_result>.5) && (actual_result < .5)) || ((expected_result<.5) && (actual_result > .5)))
    return 2.8* (expected_result-actual_result);
  else
    return PTISpreadScale*2.8* (expected_result-actual_result);
}


var ctx = document.getElementById('chartJSContainer').getContext('2d');
var pageChart;
document.getElementById("lblExpected").innerText = `Expected ${expected}`;

objToPoint = function(ps) {
  var adjust = pti_adjustment(expected,ps.eloActual);

  return ({
    x: ps.winnerGames,
    y: adjust,
    name: ps.possibleScores,
    label: ps.possibleScores
  })
}


var twoset_data = twosets.map(objToPoint)
var threeset_data = threesets.map(objToPoint)
var twoset_loss = twosetloss.map(objToPoint)
var threeset_loss = threesetloss.map(objToPoint)


function updateChart() {
  document.getElementById("lblExpected").innerText = `Expected ${(100*expected).toFixed(2)} %`;

  twoset_data = twosets.map(objToPoint)
  threeset_data = threesets.map(objToPoint)
  twoset_loss = twosetloss.map(objToPoint)
  threeset_loss = threesetloss.map(objToPoint)


  //console.log(threeset_data)

  var options = {
    type: 'scatter',
    data: {
      datasets: [{
          borderColor: "blue",
          backgroundColor: "blue",
          label: '2-Set Win',
          data: twoset_data,
          borderWidth: 1,
          showLine: false
        }, {
          borderColor: "green",
          backgroundColor: "green",
          label: '3-Set Win',
          data: threeset_data,
          borderWidth: 1,
          showLine: false
        }, {
          borderColor: "red",
          backgroundColor: "red",
          label: '2-Set Loss',
          data: twoset_loss,
          borderWidth: 1,
          showLine: false
        },
        {
          borderColor: "orange",
          backgroundColor: "orange",
          label: '3-Set Loss',
          data: threeset_loss,
          borderWidth: 1,
          showLine: false
        }

      ]
    },
    options: {
      title: {
        display: true,
        text: "PTI Movement",
        fontSize: 14,
      },
      legend: {
        display: true,
        position: 'bottom'
      },
      scales: {
        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: "Games Won"
          },
          gridLines: {
            display: true,
          },
          ticks: {
            callback: function(value, index, values) {
              //console.log("ticks");
              return value.toLocaleString();
            }
          }
        }],
        yAxes: [{
          ticks: {
            min: -3,
            max: 3
          },
          scaleLabel: {
            display: true,
            labelString: "Adjustment"
          },
          gridLines: {
            display: true,
          }
        }]
      },
      tooltips: {
        callbacks: {
          label: function(tooltipItem,data){
            return `Games Won: ${tooltipItem.xLabel}, Adjustment: ${tooltipItem.yLabel.toFixed(4)}`;
          },
          title: function(tooltipItem, all) {
            //console.log("Tooltips");
            return [
              all.datasets[tooltipItem[0].datasetIndex].label /*data[tooltipItem[0].index].name */ ,
            ]
          }

        }
      }
    }

  };



  if (typeof pageChart !== 'undefined') {
    console.log("Page Chart Update");
    pageChart.data.datasets[0].data = twoset_data;
    pageChart.data.datasets[1].data = threeset_data;
    pageChart.data.datasets[2].data = twoset_loss;
    pageChart.data.datasets[3].data = threeset_loss;

    pageChart.update();
  } else {
    console.log("Page Chart Creation");
    pageChart = new Chart(ctx, options);
  }
}

updateChart(pageChart);

function updateExpected() {
  savePTI();
  var playerPTI = parseFloat(document.getElementById('ptiPlayer').value);
  var partnerPTI = parseFloat(document.getElementById('ptiPartner').value);
  var opp1PTI = parseFloat(document.getElementById('ptiOpp1').value);
  var opp2PTI = parseFloat(document.getElementById('ptiOpp2').value);

  team1 = playerPTI + partnerPTI;
  team2 = opp1PTI + opp2PTI;

  PTISpread = team2 - team1;
  if(Math.abs(PTISpread)>=21) {
    PTISpreadScale=0;
  }
  else if (Math.abs(PTISpread)>17){
    PTISpreadScale=(21-Math.abs(PTISpread))/4;
  } else {
    PTISpreadScale=1;
  }

  

  expected = pti_expected();
  console.log(team1);
  console.log(team2);
  console.log(expected);
  dExp = expected.toFixed(4);
  document.getElementById("lblExpected").innerText = `Expected ${dExp}`;
  document.getElementById("lblSpread").innerText = `Spread ${PTISpread}`;
  document.getElementById("lblSpreadScale").innerText = `Spread Scale ${PTISpreadScale}`;

  updateChart();

}
updateExpected();
      
    </script>

  </body>
    </html>
